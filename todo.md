# AWSリソースコスト報告ツール改良タスクリスト

## 概要

このプロジェクトは、AWSリソースコスト報告ツールの出力形式と管理方法を改善するものです。現状のアウトプット形式では個別リソースの把握が難しく、時系列での変化追跡や集計・分析がしにくいという問題があります。ここでは、Git管理を考慮した効率的なデータ管理と、より使いやすいレポート形式への改良を行います。

**ベースディレクトリ**: `/Users/sugitahayato/IdeaProjects/aws-resource-cost-report`

## ディレクトリ構造設計

```
/Users/sugitahayato/IdeaProjects/aws-resource-cost-report
└── output/
    ├── raw/                     # 生データ（Git管理外）
    │   ├── YYYY-MM-DD/          # 日付ごとのフォルダ
    │   │   ├── ec2.json
    │   │   ├── s3.json
    │   │   ├── cloudfront.json
    │   │   └── ...
    ├── processed/               # 処理済みデータ（Git管理内）
    │   ├── summary.json         # 最新のサマリー情報
    │   ├── trends/              # トレンドデータ
    │   │   ├── monthly_cost.json
    │   │   ├── resource_count.json
    │   └── reports/             # レポートファイル
    │       ├── cost_by_service.md
    │       ├── resource_changes.md
    │       └── ...
    └── config/                  # 設定ファイル（Git管理内）
        ├── report_config.json   # レポート設定
        └── alert_thresholds.json # アラートしきい値
```

## タスクリスト

### ✅ Phase 1: 基本構造の実装

1. ✅ `src/processor/data_processor.py` ファイルの作成
   - `DataProcessor` クラスを実装（既に設計済み）
   - 生データを保存するメソッドの実装
   - サマリー情報を生成するメソッドの実装
   - トレンドデータを生成するメソッドの実装

2. ✅ `src/report/report_generator.py` ファイルの作成
   - ✅ 2.1. 基本クラス構造とコンストラクタの実装
   - ✅ 2.2. 設定読み込み機能の実装
   - ✅ 2.3. サマリーレポート生成メソッドの実装
   - ✅ 2.4. トレンドレポート生成メソッドの実装
   - ✅ 2.5. コストレポート生成メソッドの実装（オプション）
   - ✅ 2.6. グラフ生成ヘルパーメソッドの実装
   - ✅ 2.7. マークダウンからHTMLへの変換機能の実装

3. ✅ ディレクトリ構造の作成
   - output/ と必要なサブディレクトリを作成
   - .gitignore ファイルを更新して raw/ ディレクトリを除外

### ✅ Phase 2: メインロジックの修正

4. ✅ `src/main.py` ファイルの修正
   - ✅ 4.1. 新しいクラスをインポート
   - ✅ 4.2. 既存のデータ収集ロジックと新しいデータ処理ロジックの統合
   - ✅ 4.3. レポート生成ロジックの追加
   - ✅ 4.4. コマンドライン引数の拡張

5. ✅ `src/collectors/__init__.py` ファイルの修正
   - ✅ 5.1. 収集したデータの統一形式の定義
   - ✅ 5.2. 各コレクターの出力形式を統一

6. ✅ 設定ファイルの作成
   - ✅ 6.1. `output/config/report_config.json` の基本構造作成
   - ✅ 6.2. レポート設定オプションの実装

### ✅ Phase 3: レポート機能の実装

7. ✅ 変更レポート機能の実装
   - ✅ 7.1. `DataProcessor` クラスの `generate_change_report` メソッドの改良
   - ✅ 7.2. `ReportGenerator` クラスに変更レポート機能を追加

8. ✅ 可視化機能の実装
   - ✅ 8.1. リソース数グラフ生成機能の実装
   - ✅ 8.2. コスト推移グラフ生成機能の実装
   - ✅ 8.3. 追加のカスタムグラフ機能（オプション）

9. ✅ HTML レポート形式の追加（オプション）
   - ✅ 9.1. マークダウンからHTMLへの変換ロジックの実装
   - ✅ 9.2. HTMLテンプレート作成
   - ✅ 9.3. CSSスタイルシートの作成

### ✅ Phase 4: 既存の修正とデバッグ

10. ✅ 既存のパジネーションエラー修正を統合
    - ✅ 10.1. CloudFront コレクターの修正
    - ✅ 10.2. Route53 コレクターの修正
    - ✅ 10.3. 他のコレクターのパジネーション確認

11. ✅ CloudWatch タグ取得エラー修正を統合
    - ✅ 11.1. タグスキップロジックの実装
    - ✅ 11.2. 他のコレクターのタグ取得ロジック確認

12. ✅ エラーハンドリングの強化
    - ✅ 12.1. 例外処理の改善
    - ✅ 12.2. ログレベルの調整

### ✅ Phase 5: テストと完成

13. ✅ テストスクリプトの作成
    - ✅ 13.1. `DataProcessor` クラスのテスト
    - ✅ 13.2. `ReportGenerator` クラスのテスト
    - ✅ 13.3. 統合テスト

14. ✅ ドキュメントの更新
    - ✅ 14.1. README.md の更新
    - ✅ 14.2. 使用方法と出力例の追加

15. 🔲 最終レビューと完成
    - 🔲 15.1. コードレビュー
    - 🔲 15.2. 機能確認
    - 🔲 15.3. リリース準備

## 実装戦略

1. **段階的実装**: タスクは優先度順に実装し、まず基本機能を確立してから拡張機能に移ります。
2. **コンポーネントの分離**: 収集・処理・レポート生成の各ステップを明確に分離します。
3. **依存関係の管理**: コンポーネント間の依存関係を最小限に抑えます。
4. **エラー処理**: すべてのステップで適切なエラー処理を実装します。
5. **テスト駆動開発**: 各コンポーネントのテストを作成してから実装します。

## 必要なライブラリ

- boto3（AWS SDK）
- pandas（データ処理）
- matplotlib（可視化）
- markdown（マークダウンからHTMLへの変換）

## 注意点

- 大量のデータをGit管理するとリポジトリサイズが肥大化するため、生データは `.gitignore` で除外する
- コードの修正は既存機能を壊さないよう慎重に行う
- コレクターごとの特殊なデータ構造に対応する必要がある
- マルチリージョン対応を考慮する

## 引き継ぎ情報 (2025-03-27)

### 完了したタスク
Phase 1、Phase 2、Phase 3が完了しました：
- `DataProcessor`クラスの機能拡張：
  - 生データの保存
  - サマリー情報の生成
  - トレンドデータの生成
  - 変更レポートの生成機能の改良（コスト影響計算、セキュリティグループ変更検出など）
- `ReportGenerator`クラスの実装：
  - サマリーレポート生成
  - トレンドレポート生成
  - コストレポート生成
  - 変更レポート生成（新規実装）
  - グラフ生成機能
  - マークダウンからHTMLへの変換機能
- `main.py`を修正し、新しいデータ処理とレポート生成ロジックを統合
- `src/collectors/__init__.py`に標準データ構造を定義
- 設定ファイル`report_config.json`と`alert_thresholds.json`を作成

Phase 4も完了しました：
- CloudFrontコレクターを修正して、各APIリクエストにパジネーション処理を追加：
  - キャッシュポリシー取得
  - オリジンリクエストポリシー取得
  - 関数情報取得
- Route53コレクターを修正して、トラフィックポリシー取得のパジネーションを正しく処理
- CloudWatchコレクターを修正して、タグ取得エラーを適切に処理：
  - 権限不足エラーの特定と処理
  - タグが取得できなくても処理を続行
- エラーハンドリングを強化：
  - BaseCollectorクラスに再試行ロジックを追加
  - APIアクセスエラーに対する指数バックオフ再試行
  - 一般的なエラー処理とロギングの改善
- 新しいユーティリティモジュール（utils）を追加：
  - error_utils.pyにエラー処理ヘルパー関数を実装

Phase 5も大部分が完了しました：
- テストスクリプトを作成：
  - `tests/unit/test_data_processor.py` - DataProcessorクラスのユニットテスト
  - `tests/unit/test_report_generator.py` - ReportGeneratorクラスのユニットテスト
  - `tests/integration/test_workflow.py` - 統合テスト
- テスト用のモックデータも作成：
  - テスト用のEC2インスタンス、S3バケットのJSONデータ
  - 2つの日付（2025-02-01と2025-03-01）のサンプルデータ
- ドキュメントを更新：
  - README.mdを更新し、新機能と使用方法を追加
  - 出力ディレクトリ構造とレポート設定のカスタマイズ方法を追加

### 次に着手すべきタスク
最終的なリリース準備に向けて以下のタスクを完了する必要があります：
1. コードレビュー（タスク15.1）
   - 全体的なコードの品質チェック
   - コーディング規約の確認
   - コメントの確認・追加
2. 機能確認（タスク15.2）
   - 全機能の動作確認（実際のAWS環境で）
   - エッジケースのテスト
   - パフォーマンスチェック
3. リリース準備（タスク15.3）
   - コード内のTODOやFIXMEの解決
   - バージョン番号の更新
   - リリースノートの作成

### 実装の注意点
- すべてのテストが期待通りに動作することを確認
- 実際のAWS環境でのエンドツーエンドテストが実行できる環境を準備すること
- リリース前のチェックリストを作成し、すべての機能が期待通りに動作することを確認すること
- ドキュメントの例が最新のコマンドラインオプションと一致していることを確認すること
