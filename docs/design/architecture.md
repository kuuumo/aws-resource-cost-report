# アーキテクチャ設計

## 概要

AWS リソースコスト報告ツールは、AWSアカウント内のリソースを収集し、サービス名やリソース名、タグなどの詳細情報を含めた棚卸しレポートを生成するためのシステムです。また、時系列での変化追跡や集計・分析を容易にし、リソース管理・コスト管理を効率化します。

## システムアーキテクチャ

### 全体構成

システムは主に以下の4つのコンポーネントで構成されています：

1. **データ収集コンポーネント**
   - AWS SDKを使用して各種AWSサービスからリソース情報を収集
   - 各サービス専用のコレクタークラスが、サービス固有のAPIを呼び出し

2. **データ処理コンポーネント**
   - 収集したデータを標準化されたフォーマットに変換
   - 時系列データとして保存・管理
   - サマリー情報、変更検出、コスト計算などを実行

3. **レポート生成コンポーネント**
   - 処理されたデータから各種レポートを生成
   - マークダウンおよびHTML形式のレポート出力
   - グラフや可視化要素の生成

4. **エクスポートコンポーネント**
   - CSV、JSON形式でのデータエクスポート
   - 外部システムとの連携のためのインターフェース

### クラス構成図

```
+------------------+     +------------------+     +------------------+     +------------------+
|     Collector    |     |    Processor     |     |     Reporter     |     |     Exporter     |
+------------------+     +------------------+     +------------------+     +------------------+
| - collect_all()  |---->| - process_data() |---->| - gen_reports()  |---->| - export_data()  |
| - get_resources()|     | - analyze_data() |     | - create_visuals()|     | - format_output()|
+------------------+     +------------------+     +------------------+     +------------------+
        ^                        ^                        ^                        ^
        |                        |                        |                        |
+------------------+     +------------------+     +------------------+     +------------------+
| Service Collector|     | Data Processor   |     | Report Generator |     | Format Exporter  |
+------------------+     +------------------+     +------------------+     +------------------+
| - EC2Collector   |     | - DataProcessor  |     | - ReportGenerator|     | - CSVExporter    |
| - S3Collector    |     |                  |     |                  |     | - JSONExporter   |
| - RDSCollector   |     |                  |     |                  |     |                  |
| - etc...         |     |                  |     |                  |     |                  |
+------------------+     +------------------+     +------------------+     +------------------+
```

## データフロー

```
[AWS Services] ---> [Collectors] ---> [DataProcessor] ---> [ReportGenerator] ---> [User/System]
                       |                    |                    |
                       v                    v                    v
                  [Raw Data]         [Processed Data]      [Report Files]
                  (JSON Files)        (JSON Files)         (MD/HTML Files)
```

1. **データ収集フェーズ**
   - 各サービスコレクターがAWS APIを呼び出してリソース情報を収集
   - 収集したデータは標準化された形式でメモリ上に保持
   - 日付ごとのディレクトリに生データ（JSONファイル）として保存

2. **データ処理フェーズ**
   - 生データを読み込み、サマリー情報を生成
   - 過去のデータとの比較による変更検出
   - コスト計算やリソース数の集計

3. **レポート生成フェーズ**
   - 処理されたデータから各種レポートを生成
   - サマリーレポート、トレンドレポート、変更レポート、コストレポートなど
   - グラフや可視化要素の生成

4. **出力フェーズ**
   - レポートをマークダウンおよびHTML形式で出力
   - 生データをCSVおよびJSON形式でエクスポート

## ディレクトリ構造

```
/Users/sugitahayato/IdeaProjects/aws-resource-cost-report
├── src/                            # ソースコード
│   ├── collectors/                 # リソース収集モジュール
│   │   ├── __init__.py
│   │   ├── base_collector.py       # 基底コレクタークラス
│   │   ├── ec2_collector.py        # EC2リソース収集クラス
│   │   ├── s3_collector.py         # S3リソース収集クラス
│   │   └── ...                     # その他サービス用コレクター
│   ├── processor/                  # データ処理モジュール
│   │   └── data_processor.py       # データ処理クラス
│   ├── report/                     # レポート生成モジュール
│   │   └── report_generator.py     # レポート生成クラス
│   ├── utils/                      # ユーティリティモジュール
│   │   ├── __init__.py
│   │   └── error_utils.py          # エラー処理ユーティリティ
│   ├── collector.py                # コレクター統合モジュール
│   ├── exporters.py                # エクスポートモジュール
│   └── main.py                     # メインスクリプト
├── output/                         # 出力ディレクトリ
│   ├── raw/                        # 生データ（Git管理外）
│   │   └── YYYY-MM-DD/             # 日付ごとのディレクトリ
│   ├── processed/                  # 処理済みデータ
│   │   ├── summary.json            # サマリー情報
│   │   ├── trends/                 # トレンドデータ
│   │   └── reports/                # レポートファイル
│   └── config/                     # 設定ファイル
│       ├── report_config.json      # レポート設定
│       └── alert_thresholds.json   # アラート設定
├── tests/                          # テストコード
│   ├── unit/                       # ユニットテスト
│   ├── integration/                # 統合テスト
│   └── test_data/                  # テスト用データ
└── docs/                           # ドキュメント
    ├── design/                     # 設計ドキュメント
    ├── user_guide/                 # ユーザーガイド
    ├── developer_guide/            # 開発者ガイド
    ├── project_management/         # プロジェクト管理
    ├── api_reference/              # APIリファレンス
    └── test/                       # テスト関連ドキュメント
```

## 技術スタック

- **言語**: Python 3.8以上
- **主要ライブラリ**:
  - boto3: AWS SDKを使用したAWSサービスへのアクセス
  - pandas: データ処理と分析
  - matplotlib: データの可視化とグラフ生成
  - markdown: マークダウンからHTMLへの変換

## 拡張性と保守性

- **コンポーネントの分離**: 収集・処理・レポート生成の各ステップを明確に分離
- **依存関係の最小化**: コンポーネント間の依存関係を最小限に抑制
- **抽象化**: 基底クラスを用いた抽象化によるコードの再利用性向上
- **設定ファイル**: 外部設定ファイルを使用した柔軟な挙動のカスタマイズ
- **エラー処理**: 堅牢なエラー処理とログ出力

## セキュリティ考慮事項

- **最小権限の原則**: 必要最小限のAWS権限のみを使用
- **認証情報の管理**: AWS CLIのプロファイルを利用した安全な認証情報管理
- **データの扱い**: 機密性の高いデータはローカルに保存し、Git管理から除外

## パフォーマンス考慮事項

- **並列処理**: 大規模環境でのデータ収集時間を短縮するための並列処理
- **ページング**: 大量のリソースを効率的に処理するためのページング処理
- **再試行ロジック**: API呼び出しに対する指数バックオフを使用した再試行ロジック

## 更新履歴

| 日付 | バージョン | 説明 | 作成者 |
|------|------------|------|--------|
| 2025-03-27 | 1.0 | 初期バージョン | - |
